name: Kaniko Build

on:
  workflow_call:
    inputs:
      context:
        description: 'Build context path relative to workspace'
        required: true
        type: string
      dockerfile:
        description: 'Dockerfile path relative to context'
        required: false
        type: string
        default: 'Dockerfile'
      destination:
        description: 'Image destination (e.g., ghcr.io/org/repo:tag)'
        required: false
        type: string
        default: ''
      extra-destinations:
        description: 'Additional destinations (comma-separated)'
        required: false
        type: string
        default: ''
      push:
        description: 'Push image to registry'
        required: false
        type: boolean
        default: true
      cache:
        description: 'Enable build cache'
        required: false
        type: boolean
        default: false
    secrets:
      registry-token:
        description: 'Registry authentication token'
        required: false

jobs:
  build:
    runs-on: k8s-hetzner-arc
    steps:
      - name: Build with Kaniko sidecar
        env:
          REGISTRY_TOKEN: ${{ secrets.registry-token }}
        run: |
          # Clean previous build
          rm -rf /kaniko-build/context /kaniko-build/trigger /kaniko-build/exitcode /kaniko-build/output /kaniko-build/env

          # Copy build context
          cp -r "${{ github.workspace }}/${{ inputs.context }}" /kaniko-build/context

          # Configure registry auth if token provided
          if [ -n "$REGISTRY_TOKEN" ]; then
            mkdir -p /kaniko-build/context/.docker
            AUTH=$(echo -n "${{ github.actor }}:${REGISTRY_TOKEN}" | base64 -w 0)
            printf '{"auths":{"ghcr.io":{"auth":"%s"}}}' "${AUTH}" > /kaniko-build/context/.docker/config.json
          fi

          # Build extra args
          EXTRA_ARGS="--cache=${{ inputs.cache }}"
          if [ -n "${{ inputs.extra-destinations }}" ]; then
            for dest in $(echo "${{ inputs.extra-destinations }}" | tr ',' ' '); do
              EXTRA_ARGS="$EXTRA_ARGS --destination=$dest"
            done
          fi

          # Configure build
          cat > /kaniko-build/env << EOF
          DOCKERFILE=${{ inputs.dockerfile }}
          DESTINATION=${{ inputs.destination }}
          NO_PUSH=${{ inputs.push == false }}
          EXTRA_ARGS=$EXTRA_ARGS
          EOF

          # Trigger build
          touch /kaniko-build/trigger

          # Wait for completion (10 min timeout)
          ELAPSED=0
          while [ -f /kaniko-build/trigger ] && [ $ELAPSED -lt 600 ]; do
            sleep 2
            ELAPSED=$((ELAPSED + 2))
          done

          # Check result
          EXIT_CODE=$(cat /kaniko-build/exitcode 2>/dev/null || echo "1")
          cat /kaniko-build/output 2>/dev/null || true
          exit $EXIT_CODE
